<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Redbunny</title>
<style>
  :root{
    --bg: #000;
    --panel: #110808;
    --muted: #a0a0a0;
    --accent: #dc143c; /* Crimson */
    --accent-2: #ff4040;
    --card-border: rgba(220, 20, 60, 0.25);
    color-scheme: dark;
  }
  html,body{
    height:100%; margin:0; background: var(--bg);
    font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    color: var(--muted);
  }
  .container{max-width:1200px; margin:0 auto; padding:16px;}
  header{
    text-align:center;
    padding: 4px 0 20px;
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 999;
  }
  .logo{
    /* Adjusted for image logo */
    margin-bottom: 8px; /* Add some space below the logo */
  }
  header h1{font-size: 18px; margin: 0; color:#fff; letter-spacing: 0.5px;}
  header p{margin:2px 0 0; color:var(--muted); font-size:11px;}

  .panel{
    background: var(--panel);
    border:1px solid var(--card-border);
    border-radius:12px;
    padding:16px;
    margin-bottom: 20px;
  }

  .controls{display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:16px;}
  label{display:block; font-weight:600; font-size:14px; color:#fff; margin-bottom:8px;}
  input, select, textarea{
    width: 100%;
    box-sizing: border-box;
    background: #000;
    border:1px solid #333;
    color:#fff;
    padding:12px 14px;
    border-radius:8px;
    outline:none;
    font-size:14px;
    transition: border-color 0.2s;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--accent);
  }
  input::placeholder{color: #555;}

  .toolbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; align-items: center;}
  button{
    background: var(--accent);
    color:#fff; border:0; padding:12px 18px; border-radius:8px;
    cursor:pointer; font-weight:600; font-size: 14px;
    transition: background-color 0.2s, transform 0.1s;
    box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3);
  }
  button:hover{ background: var(--accent-2); }
  button:active{ transform: scale(1.05); }

  button.secondary{
    background:transparent;
    border:1px solid #444;
    color: var(--muted);
    box-shadow:none;
  }
  button.secondary:hover{ background: #222; color: #fff; }

  .proxy-grid-container {
    margin-top: 16px;
  }
  .proxy-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
  }
  @media (max-width: 600px) {
    .proxy-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .proxy-card {
        padding: 10px;
    }
    .proxy-card-label {
        font-size: 13px;
    }
    .proxy-card-ip {
        font-size: 11px;
        word-break: break-all; /* Allow text to wrap */
    }
  }
  .proxy-card {
    background: #1a0a0a;
    border: 1px solid var(--card-border);
    border-radius: 10px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }
  .proxy-card:hover {
    transform: translateY(-2px);
    border-color: var(--accent);
  }
  .proxy-card.selected {
    border-color: var(--accent-2);
    box-shadow: 0 0 15px rgba(220, 20, 60, 0.5);
    background: var(--accent);
  }
  .proxy-card-country {
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    margin-bottom: 8px;
    text-transform: uppercase;
  }
  .proxy-card.selected .proxy-card-country {
      color: rgba(255,255,255,0.8);
  }
  .proxy-card-label {
    font-size: 14px;
    color: #fff;
    font-weight: 600;
    margin-bottom: 4px;
    white-space: normal; /* Allow wrapping */
    word-break: break-word; /* Break long words */
  }
  .proxy-card-ip {
    font-size: 13px;
    color: var(--muted);
    font-family: 'Courier New', Courier, monospace;
  }
  .proxy-card-controls {
    display: flex;
    gap: 5px;
    justify-content: flex-end;
    margin-top: 8px;
  }
  .proxy-card-btn {
    background: rgba(0,0,0,0.4);
    color: #fff;
    border: none;
    border-radius: 5px;
    padding: 3px 6px;
    font-size: 10px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .proxy-card-btn:hover {
    background: var(--accent);
  }
  .proxy-card-btn.delete:hover {
    background: #ff4040;
  }
  .proxy-card.selected .proxy-card-ip {
      color: rgba(255,255,255,0.9);
  }
  .proxy-card-ping {
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 11px;
    color: var(--muted);
    font-weight: 600;
    background: rgba(0,0,0,0.3);
    padding: 2px 5px;
    border-radius: 4px;
  }
  .proxy-card-ping .value {
    color: #4caf50; /* Green for good ping */
  }
  .proxy-card-ping .value.medium {
    color: #ffc107; /* Yellow for medium ping */
  }
  .proxy-card-ping .value.slow {
    color: #f44336; /* Red for slow ping */
  }

  .counts{margin-top:12px; color:var(--muted); font-size:14px; text-align:center;}
  .paging-controls button { padding: 8px 12px; font-size: 13px; }

  .badges{display:flex; gap:16px; flex-wrap:nowrap; align-items: center; justify-content: center; margin-bottom: 16px;}
  .pill{
    display: inline-block;
    font-size: 13px;
    padding: 6px 12px;
    border-radius: 8px; /* Match button */
    font-weight: 600;   /* Match button */
    background: transparent;
    border: 1px solid #444;
    color: var(--muted);
    vertical-align: middle; /* Ensure alignment */
  }
  .pill#pillTotal {
    color: var(--accent);
    border-color: var(--accent);
  }
  .pill#pillSelected {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }

  .output-card h2{margin:0 0 12px 0; color:#fff; font-size:16px;}
  textarea{min-height:120px; resize:vertical; font-family: 'Courier New', Courier, monospace; background: #000;}
  .output-row{display:flex; flex-direction: column; gap:16px; margin-bottom: 16px;}
  @media (min-width: 600px) {
    .output-row{flex-direction: row;}
  }

  .modal-overlay {
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .modal-overlay.active {
    display: flex;
  }
  .modal-content {
    background: var(--panel);
    border: 1px solid var(--card-border);
    border-radius: 12px;
    padding: 24px;
    width: 90%;
    max-width: 500px;
    position: relative;
    max-height: 85vh;
    overflow-y: auto;
  }
  .modal-close {
    position: absolute;
    top: 10px;
    left: 15px;
    font-size: 24px;
    color: var(--muted);
    cursor: pointer;
    line-height: 1;
  }
  .fab-search {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: auto;
    height: 48px;
    padding: 0 24px;
    border-radius: 24px;
    background: var(--accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    cursor: pointer;
    z-index: 1001;
    border: none;
    font-size: 16px;
    font-weight: 600;
  }
  .fab-generate {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: auto;
    height: 48px;
    padding: 0 24px;
    border-radius: 24px;
    background: var(--accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    cursor: pointer;
    z-index: 1001;
    border: none;
    font-size: 16px;
    font-weight: 600;
  }
  .fab-ping {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #333;
    border: 1px solid #555;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    cursor: pointer;
    z-index: 1001;
    font-size: 24px;
  }
  .fab-ping:hover {
    background: #444;
  }
  .fab-ping.pinging {
    background: var(--accent);
    animation: pulse 1.5s infinite, wavy-shadow 1.5s infinite;
  }
  @keyframes pulse {
    0% { transform: translateX(-50%) scale(1); }
    50% { transform: translateX(-50%) scale(1.1); }
    100% { transform: translateX(-50%) scale(1); }
  }
  @keyframes wavy-shadow {
    0% { box-shadow: 0 0 0 0 rgba(220, 20, 60, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(220, 20, 60, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 20, 60, 0); }
  }
  #splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease-out;
  }
  #splash-screen.hidden {
    opacity: 0;
    pointer-events: none;
  }
  .splash-logo {
    width: 100px;
    margin-bottom: 16px;
  }
  .splash-text {
    /* Match header h1 style */
    font-size: 18px;
    margin: 0;
    color: #fff;
    letter-spacing: 0.5px;
    font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
  }
  .splash-developer {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    color: var(--muted);
    font-size: 14px;
    letter-spacing: 0.5px;
  }
  .custom-select {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #000;
    border: 1px solid #333;
    color: #fff;
    padding: 12px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .custom-select:hover {
    border-color: var(--accent);
  }
  .country-list {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 16px;
  }
  .country-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 10px;
    border-bottom: 1px solid #2a1a1a;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .country-item:hover {
    background: rgba(220, 20, 60, 0.1);
  }
  .country-item:last-child {
    border-bottom: none;
  }
  .country-item span {
    font-size: 16px;
    color: #fff;
  }
  .radio-icon {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid #555;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .country-item.selected .radio-icon {
    border-color: var(--accent);
    background: var(--accent);
  }
  .radio-icon::after {
    content: '';
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #fff;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.2s;
  }
  .country-item.selected .radio-icon::after {
    opacity: 1;
    transform: scale(1);
  }

  .input-group {
    display: flex;
    gap: 8px;
  }
  .input-group input {
    flex-grow: 1;
    min-width: 0; /* Prevents input from overflowing */
  }
  .input-group button {
    background: #333;
    border: 1px solid #444;
    color: #fff;
    box-shadow: none;
    padding: 0 14px;
    white-space: nowrap;
    font-size: 13px;
  }
  .input-group button:hover {
    background: #444;
  }

  .saved-list {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .saved-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 10px;
    background: #000;
    border: 1px solid #333;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .saved-item:hover {
    background: rgba(220, 20, 60, 0.1);
    border-color: var(--accent);
  }
  .saved-item span {
    font-size: 14px;
    color: #fff;
    word-break: break-all;
    padding-right: 10px; /* Space between text and button */
  }
  .saved-item-delete-btn {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 18px;
    cursor: pointer;
    padding: 4px;
    line-height: 1;
    transition: color 0.2s;
  }
  .saved-item-delete-btn:hover {
    color: var(--accent-2);
  }
  .modal-content-alert {
    max-width: 320px;
    text-align: center;
    padding: 32px 24px 24px 24px;
  }
  .modal-content-alert h2 {
    font-size: 18px;
    color: #fff;
    margin: 0 0 10px;
  }
  .modal-content-alert p {
    font-size: 15px;
    color: var(--muted);
    line-height: 1.5;
    margin: 0 0 24px;
  }
</style>
</head>
<body>
  <div id="splash-screen">
    <img src="https://i.postimg.cc/J04TF2Rm/20251031-150628.png" alt="Redbunny Logo" class="splash-logo">
    <h1 class="splash-text">Redbunny</h1>
    <p class="splash-developer">kangsarip developer</p>
  </div>
  <div class="container">
    <header>
      <div class="logo"><img src="https://i.postimg.cc/HstGpzdk/redbunny1.png" alt="Redbunny Logo" style="height: 40px; vertical-align: middle;"></div>
      <h1>Redbunny</h1>
      <p>VLESS & Trojan Generator</p>
    </header>

    <button class="fab-search" id="btnShowSearchModal" aria-label="Search and Filter">
      Search
    </button>

    <button class="fab-ping" id="btnPing" aria-label="Start Ping Test">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
    </button>

    <button class="fab-generate" id="btnShowGenerateModal" aria-label="Generate">
      Generate
    </button>

    <div class="panel">
      <div class="badges" style="justify-content: space-between; align-items:center; margin-bottom: 16px;">
        <span class="pill" id="pillTotal">Total: 0</span>
        <button id="addCustomProxyBtn" class="secondary" style="padding: 6px 12px; font-size: 13px;">Add Custom Proxy</button>
        <span class="pill" id="pillSelected">Selected: 0</span>
      </div>
       <div class="proxy-grid-container">
        <div id="proxyGrid" class="proxy-grid"></div>
      </div>
      <div class="counts" id="counts"></div>
    </div>
    <div class="modal-overlay" id="customProxyModal">
      <div class="modal-content">
        <span class="modal-close" id="customProxyModalCloseBtn">&times;</span>
        <h2 id="customProxyModalTitle">Add Custom Proxy</h2>
        <form id="customProxyForm">
          <input type="hidden" id="customProxyId" value="">
          <div class="controls" style="margin-top: 20px;">
            <div>
              <label for="customProxyName">Name</label>
              <input id="customProxyName" placeholder="e.g., My Server" required />
            </div>
            <div>
              <label for="customProxyIp">IP Address</label>
              <input id="customProxyIp" placeholder="e.g., 1.1.1.1" required />
            </div>
            <div>
              <label for="customProxyPort">Port</label>
              <input id="customProxyPort" type="number" placeholder="e.g., 443" required />
            </div>
          </div>
          <button type="submit" style="width:100%; margin-top: 24px;">Save Proxy</button>
        </form>
      </div>
    </div>
    <div class="modal-overlay" id="resultsModal">
    <div class="modal-content">
      <span class="modal-close" id="resultsModalCloseBtn">&times;</span>
      <h2>Results</h2>
        <div class="output-row">
          <div>
            <label for="outTrojan">Trojan</label>
            <textarea id="outTrojan" readonly></textarea>
            <button class="secondary" data-copy="#outTrojan" style="margin-top:8px;">Copy</button>
          </div>
          <div>
            <label for="outVless">VLESS</label>
            <textarea id="outVless" readonly></textarea>
            <button class="secondary" data-copy="#outVless" style="margin-top:8px;">Copy</button>
          </div>
        </div>
        <label for="outCombined">Combined</label>
        <textarea id="outCombined" readonly style="min-height:80px"></textarea>
        <button class="secondary" data-copy="#outCombined" style="margin-top:8px;">Copy All</button>
    </div>
  </div>
  <div class="modal-overlay" id="searchModal">
    <div class="modal-content">
      <span class="modal-close" id="searchModalCloseBtn">&times;</span>
      <h2>Search & Filter</h2>
      <div class="controls" style="margin-top:20px;">
        <div>
            <label>Filter by Country</label>
            <div class="custom-select" id="countrySelector">
                <span id="selectedCountry">All Countries</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
        </div>
        <div>
          <label for="search">Search (Name/IP/Port)</label>
          <input id="search" placeholder="e.g. Singapore, 43.218, :443" />
        </div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="generateModal">
    <div class="modal-content">
      <span class="modal-close" id="modalCloseBtn">&times;</span>
      <h2>Generation Settings</h2>
      <div class="controls" style="margin-top: 20px;">
        <div>
          <label for="frontDomain">Front Domain</label>
          <div class="input-group">
            <input id="frontDomain" value="df.game.naver.com" />
            <button id="btnSaveFrontDomain">Save</button>
            <button id="btnSelectFrontDomain">Select</button>
          </div>
        </div>
        <div>
          <label for="sni">SNI</label>
          <div class="input-group">
            <input id="sni" value="df.game.naver.com.redbunny.dpdns.org" />
            <button id="btnSaveSni">Save</button>
            <button id="btnSelectSni">Select</button>
          </div>
        </div>
        <div>
          <label for="hostHeader">Host Header (optional)</label>
          <input id="hostHeader" placeholder="Defaults to SNI" value="" />
        </div>
        <div>
          <label for="cfTlsPort">TLS Port</label>
          <input id="cfTlsPort" type="number" min="1" max="65535" value="443" />
        </div>
      </div>
      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--card-border);">
        <label>Account Types</label>
        <div style="display:flex; gap:16px; align-items:center;">
          <label style="display:flex; align-items:center; gap:8px; font-weight:normal; color:#fff"><input id="genTrojan" type="checkbox" checked> Trojan</label>
          <label style="display:flex; align-items:center; gap:8px; font-weight:normal; color:#fff"><input id="genVless" type="checkbox" checked> VLESS</label>
        </div>
      </div>
      <button id="btnConfirmGenerate" style="width:100%; margin-top: 24px;">Generate</button>
    </div>
  </div>

  <div class="modal-overlay" id="countryModal">
    <div class="modal-content">
      <span class="modal-close" id="countryModalCloseBtn">&times;</span>
      <h2>Select a Country</h2>
      <div class="country-list" id="countryList">
        <!-- Countries will be populated by JS -->
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="savedListModal">
    <div class="modal-content">
      <span class="modal-close" id="savedListModalCloseBtn">&times;</span>
      <h2 id="savedListModalTitle">Saved Items</h2>
      <div class="saved-list" id="savedListContainer">
        <!-- Items will be populated by JS -->
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="alertModal">
    <div class="modal-content modal-content-alert">
      <h2 id="alertModalTitle">Notification</h2>
      <p id="alertModalMessage"></p>
      <button id="alertModalCloseBtn">OK</button>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const PAGE_SIZE = 200;

let ALL_ITEMS = [];
let CUSTOM_ITEMS = [];
let FILTERED_ITEMS = [];
let SELECTED = new Map(); // key => {ip, port, label}
let currentPage = 1;
let isPinging = false;
let pingController = null;

// Element Refs
const elSearch = $("#search");
const proxyGrid = $("#proxyGrid");
const addCustomProxyBtn = $("#addCustomProxyBtn");
const elCounts = $("#counts");
const elPillTotal = $("#pillTotal");
const elPillSelected = $("#pillSelected");
const btnPing = $("#btnPing");

// Modal Refs
const generateModal = $("#generateModal");
const showModalBtn = $("#btnShowGenerateModal");
const closeModalBtn = $("#modalCloseBtn");
const confirmGenerateBtn = $("#btnConfirmGenerate");
const searchModal = $("#searchModal");
const showSearchModalBtn = $("#btnShowSearchModal");
const closeSearchModalBtn = $("#searchModalCloseBtn");
const resultsModal = $("#resultsModal");
const closeResultsModalBtn = $("#resultsModalCloseBtn");
const countryModal = $("#countryModal");
const countrySelector = $("#countrySelector");
const countryList = $("#countryList");
const selectedCountryEl = $("#selectedCountry");
const closeCountryModalBtn = $("#countryModalCloseBtn");
const customProxyModal = $("#customProxyModal");
const customProxyModalCloseBtn = $("#customProxyModalCloseBtn");
const customProxyForm = $("#customProxyForm");
const savedListModal = $("#savedListModal");
const savedListModalCloseBtn = $("#savedListModalCloseBtn");
const savedListContainer = $("#savedListContainer");
const savedListModalTitle = $("#savedListModalTitle");
const alertModal = $("#alertModal");
const alertModalTitle = $("#alertModalTitle");
const alertModalMessage = $("#alertModalMessage");
const alertModalCloseBtn = $("#alertModalCloseBtn");

// Input Refs
const elFrontDomain = $("#frontDomain");
const elSni = $("#sni");

// Saved Items
let SAVED_SNIS = [];
let SAVED_FRONT_DOMAINS = [];
let currentListType = ''; // 'sni' or 'frontDomain'


// --- Helper Functions ---
function showCustomAlert(message, title = 'Notification') {
  alertModalTitle.textContent = title;
  alertModalMessage.textContent = message;
  openModal(alertModal);
}

let selectedCountry = 'all';

function populateCountryFilter() {
    const combinedItems = [...CUSTOM_ITEMS, ...ALL_ITEMS];
    const countries = new Set(combinedItems.map(item => item.country).filter(Boolean));
    const sortedCountries = ['All Countries', ...[...countries].sort()];

    countryList.innerHTML = ''; // Clear previous list
    for (const country of sortedCountries) {
        if (!country || country === 'Unknown') continue;

        const countryCode = country === 'All Countries' ? 'all' : country;
        const item = document.createElement('div');
        item.className = 'country-item';
        item.dataset.value = countryCode;
        item.innerHTML =
            '<span>' + country + '</span>' +
            '<div class="radio-icon"></div>';
        item.addEventListener('click', () => {
            if (selectedCountry !== countryCode) {
                stopPing(); // Stop pinging when country changes
            }
            selectedCountry = countryCode;
            selectedCountryEl.textContent = country;

            // Update selected class
            countryList.querySelectorAll('.country-item').forEach(it => it.classList.remove('selected'));
            item.classList.add('selected');

            setTimeout(() => {
              countryModal.classList.remove('active');
              searchModal.classList.remove('active');
            }, 150);
            filterData();
        });
        countryList.appendChild(item);
    }
}

// --- Core Functions ---
function parseTextProxies(text) {
  const lines = String(text).split(/\r?\n/);
  const items = [];
  for (let line of lines) {
    line = line.trim();
    if (!line || line.startsWith("#")) continue;

    const parts = line.split(',');
    if (parts.length >= 4) {
      const ip = parts[0].trim();
      const port = parseInt(parts[1].trim(), 10);
      const country = parts[2].trim().toUpperCase();
      const label = sanitizeLabel(parts.slice(3).join(',').trim()); // Join the rest for provider name

      if (ip && port && country) {
        items.push({ ip, port, country, label });
      }
    }
  }
  return items;
}

function dedupeAndValidate(items) {
  const seen = new Set();
  const out = [];
  for (const it of items) {
    const ip = String(it.ip || "").trim();
    const port = Number(it.port || 0);
    if (!isIPv4(ip)) continue;
    if (!Number.isInteger(port) || port < 1 || port > 65535) continue;
    const key = `${ip}:${port}`;
    if (seen.has(key)) continue;
    seen.add(key);
    out.push({ ip, port, label: sanitizeLabel(it.label || ""), country: it.country || 'Unknown' });
  }
  out.sort((a, b) => {
    if (a.country !== b.country) return a.country < b.country ? -1 : 1;
    const la = a.label.toLowerCase(), lb = b.label.toLowerCase();
    if (la !== lb) return la < lb ? -1 : 1;
    if (a.ip !== b.ip) return a.ip < b.ip ? -1 : 1;
    return a.port - b.port;
  });
  return out;
}

function isIPv4(s) {
  if (!/^(\d{1,3}\.){3}\d{1,3}$/.test(s)) return false;
  return s.split(".").every(n => {
    const v = Number(n);
    return v >= 0 && v <= 255;
  });
}
function sanitizeLabel(label) {
  label = String(label || "").replace(/[\[\]]/g, "").replace(/\s+/g, " ").trim();
  return label;
}

// --- Saved Item Storage ---
function getSavedItems(key) {
  try {
    const data = localStorage.getItem(key);
    const items = data ? JSON.parse(data) : [];
    // Basic validation to ensure it's an array of strings
    if (Array.isArray(items) && items.every(i => typeof i === 'string')) {
      return items;
    }
    return [];
  } catch (e) {
    console.error(`Failed to parse ${key} from localStorage`, e);
    return [];
  }
}

function saveItems(key, items) {
  try {
    // Deduplicate and save
    const uniqueItems = [...new Set(items)];
    localStorage.setItem(key, JSON.stringify(uniqueItems));
  } catch (e) {
    console.error(`Failed to save ${key} to localStorage`, e);
  }
}

function renderSavedList(items, type) {
  savedListContainer.innerHTML = '';
  if (items.length === 0) {
    savedListContainer.innerHTML = '<p style="text-align: center; color: var(--muted);">No items saved yet.</p>';
    return;
  }

  items.forEach(item => {
    const el = document.createElement('div');
    el.className = 'saved-item';
    el.innerHTML = `
      <span>${escapeHtml(item)}</span>
      <button class="saved-item-delete-btn" data-value="${escapeHtml(item)}">&times;</button>
    `;

    // Click on the item itself (not the delete button)
    el.addEventListener('click', (e) => {
      if (e.target.tagName !== 'BUTTON') {
        if (type === 'sni') {
          elSni.value = item;
        } else if (type === 'frontDomain') {
          elFrontDomain.value = item;
        }
        closeModal(savedListModal);
      }
    });

    // Click on the delete button
    el.querySelector('.saved-item-delete-btn').addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent the item click event from firing
      const valueToDelete = e.currentTarget.dataset.value;
      if (type === 'sni') {
        SAVED_SNIS = SAVED_SNIS.filter(i => i !== valueToDelete);
        saveItems('savedSnIs', SAVED_SNIS);
        renderSavedList(SAVED_SNIS, 'sni'); // Re-render the list
      } else if (type === 'frontDomain') {
        SAVED_FRONT_DOMAINS = SAVED_FRONT_DOMAINS.filter(i => i !== valueToDelete);
        saveItems('savedFrontDomains', SAVED_FRONT_DOMAINS);
        renderSavedList(SAVED_FRONT_DOMAINS, 'frontDomain'); // Re-render the list
      }
    });

    savedListContainer.appendChild(el);
  });
}

// --- Custom Proxy Storage ---
function getCustomProxies() {
  try {
    const data = localStorage.getItem('customProxies');
    const proxies = data ? JSON.parse(data) : [];
    return proxies.map(p => ({...p, id: p.id || crypto.randomUUID(), isCustom: true}));
  } catch (e) {
    console.error("Failed to parse custom proxies from localStorage", e);
    return [];
  }
}

function saveCustomProxies() {
  try {
    // Don't save the isCustom flag
    const toSave = CUSTOM_ITEMS.map(({ isCustom, ...rest }) => rest);
    localStorage.setItem('customProxies', JSON.stringify(toSave));
  } catch (e) {
    console.error("Failed to save custom proxies to localStorage", e);
  }
}

async function loadData() {
  CUSTOM_ITEMS = getCustomProxies();
  SAVED_SNIS = getSavedItems('savedSnIs');
  SAVED_FRONT_DOMAINS = getSavedItems('savedFrontDomains');

  const proxyUrl = "https://raw.githubusercontent.com/mrzero0nol/My-v2ray/refs/heads/main/proxyList.txt";
  showModalBtn.disabled = true;
  showModalBtn.textContent = 'Loading...';
  try {
    const res = await fetch(proxyUrl);
    if (!res.ok) throw new Error('Network response was not ok');
    const rawText = await res.text();

    let items = parseTextProxies(rawText);
    items = dedupeAndValidate(items);

    ALL_ITEMS = items;
    populateCountryFilter();
    filterData();
  } catch (err) {
    console.error("Failed to load data:", err);
    proxyGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color:var(--accent);">Failed to load proxy list.</p>';
  } finally {
    showModalBtn.disabled = false;
    showModalBtn.textContent = 'Generate';
  }
}

function filterData() {
  const q = elSearch.value.trim().toLowerCase();

  const combinedItems = [...CUSTOM_ITEMS, ...ALL_ITEMS];
  let items = combinedItems;

  if (selectedCountry !== 'all') {
    items = items.filter(x => x.country === selectedCountry);
  }

  if (q) {
    items = items.filter(x =>
      (x.label || "").toLowerCase().includes(q) ||
      (x.ip || "").toLowerCase().includes(q) ||
      String(x.port || "").toLowerCase().includes(q)
    );
  }

  FILTERED_ITEMS = items;
  currentPage = 1;
  render();
}

function keyOf(x) { return x.isCustom ? x.id : (x.ip + ':' + x.port); }

function render() {
  const total = FILTERED_ITEMS.length;
  const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if (currentPage > pages) currentPage = pages;
  const start = (currentPage - 1) * PAGE_SIZE;
  const slice = FILTERED_ITEMS.slice(start, start + PAGE_SIZE);

  proxyGrid.innerHTML = ''; // Clear grid

  if (slice.length === 0) {
    proxyGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">No data found.</p>';
  } else {
    slice.forEach(it => {
      const k = keyOf(it);
      const card = document.createElement('div');
      card.className = 'proxy-card';
      if (SELECTED.has(k)) {
        card.classList.add('selected');
      }
      card.dataset.key = k;

      let customControls = '';
      if (it.isCustom) {
          customControls = `
              <div class="proxy-card-controls">
                  <button class="proxy-card-btn edit" data-id="${it.id}">Edit</button>
                  <button class="proxy-card-btn delete" data-id="${it.id}">Delete</button>
              </div>
          `;
      }

      card.innerHTML =
        '<div class="proxy-card-ping" data-ping-key="' + k + '"><span class="value">N/A</span></div>' +
        '<div class="proxy-card-country">' + escapeHtml(it.country || (it.isCustom ? 'CUSTOM' : 'Unknown')) + '</div>' +
        '<div class="proxy-card-label" title="' + escapeHtml(it.label) + '">' + (it.label ? escapeHtml(it.label) : '(No Name)') + '</div>' +
        '<div class="proxy-card-ip">' + it.ip + ':' + it.port + '</div>' +
        customControls; // Moved to the bottom

      card.addEventListener('click', (e) => {
        if (!e.target.classList.contains('proxy-card-btn')) {
          toggleSelection(card, it);
        }
      });
      proxyGrid.appendChild(card);
    });
  }

  elCounts.innerHTML = renderPaging(total, pages);
  bindPaging();
  updatePills();
}

function toggleSelection(cardElement, item) {
    const key = keyOf(item);
    if (SELECTED.has(key)) {
        SELECTED.delete(key);
        cardElement.classList.remove('selected');
    } else {
        SELECTED.set(key, item);
        cardElement.classList.add('selected');
    }
    updatePills();
}

function bindPaging() {
  elCounts.querySelectorAll("[data-page]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      const p = btn.getAttribute("data-page");
      if (p === "prev") currentPage = Math.max(1, currentPage - 1);
      else if (p === "next") currentPage = Math.min(pages, currentPage + 1);
      else currentPage = parseInt(p, 10);
      render();
    });
  });
}

function renderPaging(total, pages) {
  if (total <= PAGE_SIZE) return total + ' results';
  let pageLinks = "";
  const maxShow = 5;
  let start = Math.max(1, currentPage - 2);
  let end = Math.min(pages, start + maxShow - 1);
  if (end - start + 1 < maxShow) start = Math.max(1, end - maxShow + 1);

  pageLinks += '<button class="secondary paging-controls" data-page="prev" ' + (currentPage === 1 ? 'disabled' : '') + '>◀</button>';
  for (let p = start; p <= end; p++) {
    const act = p === currentPage ? "style='background:var(--accent); color:#fff; border-color:var(--accent)'" : "";
    pageLinks += '<button class="secondary paging-controls" data-page="' + p + '" ' + act + '>' + p + '</button>';
  }
  pageLinks += '<button class="secondary paging-controls" data-page="next" ' + (currentPage === pages ? 'disabled' : '') + '>▶</button>';

  return 'Page ' + currentPage + '/' + pages + ' (' + total + ' results) <div style="margin-top:8px;">' + pageLinks + '</div>';
}

function updatePills() {
  elPillTotal.textContent = "Total: " + ALL_ITEMS.length;
  elPillSelected.textContent = "Selected: " + SELECTED.size;
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
  }[c]));
}

const DEFAULTS = {
  frontDomain: "df.game.naver.com",
  sni: "df.game.naver.com.redbunny.dpdns.org",
  hostHeader: "",
  cfTlsPort: 443,
  genTrojan: true,
  genVless: true
};

function buildURIs(proxy, opts) {
  const { frontDomain, sni, hostHeader, cfTlsPort = 443, includeTrojan = true, includeVless = true } = opts;
  const ip = proxy.ip;
  const backendPort = proxy.port || 443;
  const tagLabel = (proxy.label ? `${proxy.label} [${ip}]` : `[${ip}]`);
  const path = `/${ip}-${backendPort}`;
  const qpath = encodeURIComponent(path);
  const host = hostHeader || sni;

  let trojan = null, vless = null;

  if (includeTrojan) {
    // Note: crypto.randomUUID() is available in secure contexts (HTTPS) and modern browsers.
    // For WebView, it should generally be available.
    const pass = self.crypto.randomUUID();
    trojan = `trojan://${pass}@${frontDomain}:${cfTlsPort}/?type=ws&host=${host}&path=${qpath}&security=tls&sni=${sni}#${encodeURIComponent(tagLabel)}`;
  }
  if (includeVless) {
    const uuid = self.crypto.randomUUID();
    vless = `vless://${uuid}@${frontDomain}:${cfTlsPort}/?type=ws&encryption=none&flow=&host=${host}&path=${qpath}&security=tls&sni=${sni}#${encodeURIComponent(tagLabel)}`;
  }
  return { trojan, vless, tag: tagLabel };
}

function handleGenerate() {
  const selected = Array.from(SELECTED.values());
  if (!selected.length) {
    showCustomAlert("Please select at least one proxy before generating.");
    return;
  }
  confirmGenerateBtn.textContent = 'Generating...';
  confirmGenerateBtn.disabled = true;

  try {
    const genOptions = {
      frontDomain: $("#frontDomain").value.trim() || DEFAULTS.frontDomain,
      sni: $("#sni").value.trim() || DEFAULTS.sni,
      hostHeader: $("#hostHeader").value.trim(),
      cfTlsPort: +$("#cfTlsPort").value || DEFAULTS.cfTlsPort,
      includeTrojan: $("#genTrojan").checked,
      includeVless: $("#genVless").checked
    };

    const trojanList = [];
    const vlessList = [];

    for (const p of selected) {
      const { trojan, vless } = buildURIs(p, genOptions);
      if (trojan) trojanList.push(trojan);
      if (vless) vlessList.push(vless);
    }

    const combined = [...trojanList, ...vlessList].join("\n");

    $("#outTrojan").value = trojanList.join("\n");
    $("#outVless").value = vlessList.join("\n");
    $("#outCombined").value = combined;

    closeModal(generateModal);
    openModal(resultsModal);
  } catch (err) {
    showCustomAlert("Failed to generate: " + err.message);
  } finally {
    confirmGenerateBtn.textContent = 'Confirm & Generate';
    confirmGenerateBtn.disabled = false;
  }
}

// --- Modal Handling with Viewport Awareness ---
function openModal(modalElement) {
    if (!modalElement) return;
    modalElement.classList.add('active');
    // Call handler immediately to adjust for a keyboard that might already be open.
    handleViewportChange();
}

function closeModal(modalElement) {
    if (modalElement) {
        modalElement.classList.remove('active');
        // Reset any inline styles that might have been added by viewport handler
        modalElement.style.alignItems = '';
        const content = modalElement.querySelector('.modal-content');
        if (content) {
            content.style.maxHeight = '';
        }
    }
}

// --- Event Listeners ---
elSearch.addEventListener("input", () => {
  clearTimeout(window.__deb);
  window.__deb = setTimeout(filterData, 200);
});

showModalBtn.addEventListener("click", () => {
  if (SELECTED.size === 0) {
    showCustomAlert("Please select at least one proxy before generating.");
    return;
  }
  openModal(generateModal);
});

closeModalBtn.addEventListener("click", () => closeModal(generateModal));
generateModal.addEventListener("click", (e) => {
  if (e.target === generateModal) closeModal(generateModal);
});

showSearchModalBtn.addEventListener("click", () => openModal(searchModal));
closeSearchModalBtn.addEventListener("click", () => closeModal(searchModal));
searchModal.addEventListener("click", (e) => {
    if (e.target === searchModal) closeModal(searchModal);
});

closeResultsModalBtn.addEventListener("click", () => closeModal(resultsModal));
resultsModal.addEventListener("click", (e) => {
    if (e.target === resultsModal) closeModal(resultsModal);
});

countrySelector.addEventListener("click", () => openModal(countryModal));
closeCountryModalBtn.addEventListener("click", () => closeModal(countryModal));
countryModal.addEventListener("click", (e) => {
    if (e.target === countryModal) closeModal(countryModal);
});

confirmGenerateBtn.addEventListener("click", handleGenerate);

document.querySelectorAll("button[data-copy]").forEach(b => {
  b.addEventListener("click", async () => {
    const t = document.querySelector(b.getAttribute("data-copy"));
    if (!t || !t.value) return;
    try {
      await navigator.clipboard.writeText(t.value);
      b.textContent = "Copied!";
    } catch {
      t.select();
      document.execCommand("copy");
      b.textContent = "Copied!";
    }
    setTimeout(() => (b.textContent = "Copy"), 1500);
  });
});

addCustomProxyBtn.addEventListener("click", () => {
  customProxyForm.reset();
  $("#customProxyId").value = "";
  $("#customProxyModalTitle").textContent = "Add Custom Proxy";
  openModal(customProxyModal);
});

customProxyModalCloseBtn.addEventListener("click", () => closeModal(customProxyModal));
customProxyModal.addEventListener("click", (e) => {
    if (e.target === customProxyModal) closeModal(customProxyModal);
});

customProxyForm.addEventListener("submit", (e) => {
  e.preventDefault();
  const id = $("#customProxyId").value;
  const newProxy = {
    id: id || crypto.randomUUID(),
    label: $("#customProxyName").value.trim(),
    ip: $("#customProxyIp").value.trim(),
    port: parseInt($("#customProxyPort").value, 10),
    isCustom: true,
    country: 'CUSTOM'
  };

  if (!isIPv4(newProxy.ip) || !newProxy.port) {
    showCustomAlert("Invalid IP address or port.");
    return;
  }

  if (id) {
    // Editing
    const index = CUSTOM_ITEMS.findIndex(p => p.id === id);
    if (index > -1) {
      CUSTOM_ITEMS[index] = newProxy;
    }
  } else {
    // Adding
    CUSTOM_ITEMS.unshift(newProxy);
  }

  saveCustomProxies();
  filterData(); // This will re-render
  closeModal(customProxyModal);
});

proxyGrid.addEventListener("click", (e) => {
  const target = e.target;
  const id = target.dataset.id;
  if (!id) return;

  if (target.classList.contains("edit")) {
    const proxy = CUSTOM_ITEMS.find(p => p.id === id);
    if (proxy) {
      $("#customProxyId").value = proxy.id;
      $("#customProxyName").value = proxy.label;
      $("#customProxyIp").value = proxy.ip;
      $("#customProxyPort").value = proxy.port;
      $("#customProxyModalTitle").textContent = "Edit Custom Proxy";
      openModal(customProxyModal);
    }
  } else if (target.classList.contains("delete")) {
    if (confirm("Are you sure you want to delete this proxy?")) {
      CUSTOM_ITEMS = CUSTOM_ITEMS.filter(p => p.id !== id);
      saveCustomProxies();
      filterData();
    }
  }
});

$("#btnSaveFrontDomain").addEventListener('click', () => {
  const value = elFrontDomain.value.trim();
  if (value) {
    SAVED_FRONT_DOMAINS.push(value);
    saveItems('savedFrontDomains', SAVED_FRONT_DOMAINS);
    showCustomAlert(`"${value}" saved!`);
  }
});

$("#btnSelectFrontDomain").addEventListener('click', () => {
  currentListType = 'frontDomain';
  savedListModalTitle.textContent = 'Select a Front Domain';
  renderSavedList(SAVED_FRONT_DOMAINS, currentListType);
  openModal(savedListModal);
});

$("#btnSaveSni").addEventListener('click', () => {
  const value = elSni.value.trim();
  if (value) {
    SAVED_SNIS.push(value);
    saveItems('savedSnIs', SAVED_SNIS);
    showCustomAlert(`"${value}" saved!`);
  }
});

$("#btnSelectSni").addEventListener('click', () => {
  currentListType = 'sni';
  savedListModalTitle.textContent = 'Select an SNI';
  renderSavedList(SAVED_SNIS, currentListType);
  openModal(savedListModal);
});

savedListModalCloseBtn.addEventListener('click', () => closeModal(savedListModal));
savedListModal.addEventListener('click', (e) => {
  if (e.target === savedListModal) {
    closeModal(savedListModal);
  }
});

alertModalCloseBtn.addEventListener('click', () => closeModal(alertModal));

// --- Ping Functionality ---
async function pingProxy(proxy) {
  const key = keyOf(proxy);
  const pingElement = document.querySelector(`.proxy-card-ping[data-ping-key="${key}"] .value`);
  if (!pingElement) return;

  pingElement.textContent = '...';
  pingElement.className = 'value'; // Reset color

  const startTime = Date.now();
  try {
    const response = await fetch(`http://${proxy.ip}:${proxy.port}`, {
      method: 'GET',
      mode: 'no-cors', // Use no-cors to measure connection time, though we can't read the response
      signal: pingController.signal
    });
    // This part of the code will likely not be reached due to "no-cors"
    // The measurement is based on the time it takes for the request to complete or fail
  } catch (e) {
    if (e.name === 'AbortError') {
      pingElement.textContent = 'N/A';
      return; // Ping was cancelled
    }
    // Network errors are expected with 'no-cors'. We proceed to calculate latency.
  }

  const latency = Date.now() - startTime;

  if (pingController.signal.aborted) {
    pingElement.textContent = 'N/A';
    return;
  }

  pingElement.textContent = `${Math.floor(latency / 10)} ms`;
  if (latency < 500) {
    pingElement.classList.add('good');
  } else if (latency < 1000) {
    pingElement.classList.add('medium');
  } else {
    pingElement.classList.add('slow');
  }
}

async function startPing() {
  if (isPinging) return;
  isPinging = true;
  btnPing.classList.add('pinging');
  btnPing.setAttribute('aria-label', 'Stop Ping Test');
  pingController = new AbortController();

  const proxiesToPing = FILTERED_ITEMS.slice(0, PAGE_SIZE); // Only ping visible proxies

  for (const proxy of proxiesToPing) {
    if (!isPinging) break;
    await pingProxy(proxy);
    await new Promise(resolve => setTimeout(resolve, 50)); // Small delay between pings
  }

  if (isPinging) {
    stopPing(); // Automatically stop when done
  }
}

function stopPing() {
  if (!isPinging) return;
  isPinging = false;
  if (pingController) {
    pingController.abort();
  }
  btnPing.classList.remove('pinging');
  btnPing.setAttribute('aria-label', 'Start Ping Test');
  document.querySelectorAll('.proxy-card-ping .value').forEach(el => {
    if (el.textContent === '...') {
      el.textContent = 'N/A';
    }
  });
}

btnPing.addEventListener('click', () => {
  if (isPinging) {
    stopPing();
  } else {
    startPing();
  }
});


// --- Visual Viewport Correction for Virtual Keyboard ---
function handleViewportChange() {
  const activeModalOverlay = document.querySelector('.modal-overlay.active');
  if (!activeModalOverlay) return;
  const activeModalContent = activeModalOverlay.querySelector('.modal-content');
  if (!activeModalContent) return;

  const viewport = window.visualViewport;
  if (!viewport) return;

  const availableHeight = viewport.height;
  const windowHeight = window.innerHeight;

  // If viewport height is significantly smaller than window height, assume keyboard is open.
  if (availableHeight < windowHeight * 0.9) { // Using 0.9 as a threshold
    activeModalOverlay.style.alignItems = 'flex-start';
    activeModalContent.style.maxHeight = (availableHeight - 40) + 'px'; // 40px buffer
  } else {
    // Keyboard is likely closed, revert to CSS default by removing the inline style
    activeModalOverlay.style.alignItems = '';
    activeModalContent.style.maxHeight = '';
  }
}

function setupViewportListener() {
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', handleViewportChange);
    }
}

// Initial Load
loadData();
setupViewportListener();

window.addEventListener('DOMContentLoaded', () => {
  const splash = document.getElementById('splash-screen');
  setTimeout(() => {
    splash.classList.add('hidden');
    setTimeout(() => {
      splash.style.display = 'none';
    }, 500); // Match CSS transition duration
  }, 3000);
});
</script>
</body>
</html>
